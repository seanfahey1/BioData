---
title: "BIOL606_hw_Lecture04_Fahey.Rmd"
author: "Sean Fahey"
date: "2023-01-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(ggplot2)
library(lme4)
library(stargazer)
```

```{r question 1}
# Import both data files, call them "cucumberdamage" and "flowercounts".

flowercounts <- read.csv("lecture3_flowercounts.csv")
flowercounts$plant <- as.factor(flowercounts$plant) # this converts the plant column from an integer to a factor datatype

summary(flowercounts)
head(flowercounts)

cucumberdamage <- read.csv("lecture3_cucumberdamage.csv")
cucumberdamage$plant <- as.factor(cucumberdamage$plant)

summary(cucumberdamage)
head(cucumberdamage)
```

```{r question 2}
# Determine the total number (sum) of male and female flowers combined on each plant (i.e., total number of flowers, males + females).

flowercounts = summarize(
  group_by(flowercounts, plant),
  sumF = sum(F),
  sumM = sum(M),
  sumTotal = sum(M) + sum(F)
  )

flowercounts = slice(flowercounts, 1:200) # summarize spits out an NA row at the end. This seems to get rid of it.

tail(flowercounts)
```

``` {r question 3}
# Join the total flower number count with the cucumberdamage dataframe

combined = bind_cols(flowercounts, cucumberdamage)
#combined$pollination <- as.factor(combined$pollination)
#combined$herbivory <- as.factor(combined$herbivory)
head(combined)
```

``` {r question 4}
# Use a t-test to determine if the hand-pollination treatment affects flower number. In your annotation, explain how you interpret the result of the t-test (in your own words)

t.test(combined$sumTotal ~ combined$pollination)

# It looks like we can't reject the null hypothesis with 95% confidence (that there's no difference between pollination methods). So there isn't a statistical difference between the pollination methods.
```

``` {r question 5}
# Make a figure in ggplot depicting flower number and pollination treatment

ggplot(combined,
       aes(
         x=pollination,
         y=sumTotal
       )) +
  geom_boxplot(
    outlier.alpha = 0, # don't show my outliers, they'll show up in the geom_jitter plot
    notch = TRUE, # add a notch
    notchwidth = 0.8, # set notch width (default is 0.5)
    na.rm = TRUE, # drop NA values so I don't get warnings
  ) +
  geom_jitter(
    shape = 21,
    size = 1,
    position = position_jitter(0.05)
  ) +
  theme_bw() +
  labs(
    x = "Pollination Method",
    y = "Total Number of Flowers",
    title = "Flower Count by Pollination Method"
  )
```

``` {r question 6}
# On each plant, the lengths of 3 leaves were measured (leaf1length, leaf2length, leaf3length in the cucumberdamage dataframe). First, use dplyr to calculate mean leaf length of each plant. Then, test the hypothesis that hand-pollination decreases leaf size.

# mutate to create a new column of mean leaf lengths
combined = mutate(
  combined, 
  meanLeaf = (
    leaf1length +  
    leaf2length + 
    leaf3length)
  /3)

t.test(combined$meanLeaf ~ combined$pollination)
# It looks like we still can't reject the null hypothesis that pollination method has no effect on mean leaf length with at least 95% confidence.
```

``` {r question 7}
# Make a ggplot illustrating the results of leaf length vs hand polliantion.

ggplot(combined,
       aes(
         x=pollination,
         y=meanLeaf
       )) +
  geom_boxplot(
    outlier.alpha = 0, # don't show my outliers, they'll show up in the geom_jitter plot
    notch = TRUE, # add a notch
    notchwidth = 0.8, # set notch width (default is 0.5)
    na.rm = TRUE, # drop NA values so I don't get warnings
  ) +
  geom_jitter(
    shape = 21,
    size = 1,
    position = position_jitter(0.05)
  ) +
  theme_bw() +
  labs(
    x = "Pollination Method",
    y = "Mean Leaf Length",
    title = "Mean Leaf Length by Pollination Method"
  )
```

``` {r Hajduk loading and normalizing}
load("dragons.RData")
summary(dragons)

# look at the distribution. Make sure it's normal.
hist(dragons$testScore)

# standardize the column so mean is 0 and standard deviation is 1
dragons$bodyLength2 <- scale(dragons$bodyLength)
```

``` {r Hajduk plot linear model}

# start with a linear model
basic.lm <- lm(testScore ~ bodyLength2, data = dragons)
summary(basic.lm)

# plot it
ggplot(dragons, aes(x = bodyLength, y = testScore)) +
  geom_point() +
  geom_smooth(method = "lm") 
```

``` {r Hajduk plot residuals}

# which = 1 sets it to plot residuals
plot(basic.lm, which = 1)
```

``` {r Hajduk Q-Q plot}

# which = 2 selects a Q-Q plot
plot(basic.lm, which = 2)
```

``` {r observation independence}

# checking if mountain range affects test score
boxplot(testScore ~ mountainRange, data = dragons)

# same but with color so we can see body length v. test score correlation per mountain range
ggplot(dragons, aes(x = bodyLength, y = testScore, colour = mountainRange)) +
  geom_point(size = 2) +
  theme_classic() +
    theme(legend.position = "none")
```

``` {r multiple analyses}

# same but with faceted plots instead of color

ggplot(
  aes(
    bodyLength, 
    testScore
    ), 
  data = dragons) + 
  geom_point() + 
  facet_wrap(~ mountainRange) + 
  xlab("length") + 
  ylab("test score")
```

``` {r modify the current model}
# different model
mountain.lm <- lm(testScore ~ bodyLength2 + mountainRange, data = dragons)
summary(mountain.lm)
```

``` {r Mixed effects model}
# get linear model
mixed.lmer <- lmer(testScore ~ bodyLength2 + (1|mountainRange), data = dragons)
summary(mixed.lmer)

plot(mixed.lmer)

# plot the qqnorm plot
qqnorm(resid(mixed.lmer))
qqline(resid(mixed.lmer))
```

``` {r Types of random effects}
head(dragons)
str(dragons)
dragons <- within(dragons, sample <- factor(mountainRange:site))
```

``` {r second mixed model}

mixed.lmer2 <- lmer(testScore ~ bodyLength2 + (1|mountainRange) + (1|sample), data = dragons)
summary(mixed.lmer2)

# plot each body length v. test score per mountain range. Colored by Site.
ggplot(dragons, aes(x = bodyLength, y = testScore, colour = site)) +
  facet_wrap(~mountainRange, nrow=3) +
  geom_point() +
  theme_classic() +
  geom_line(data = cbind(dragons, pred = predict(mixed.lmer2)), aes(y = pred)) +
  theme(legend.position = "none")
```

``` {r Presenting your model results using stargazer}

# stargazer example
stargazer(mixed.lmer2, type = "text",
          digits = 3,
          star.cutoffs = c(0.05, 0.01, 0.001),
          digit.separator = "")
```

``` {r model selection}
# set up 2 different models
full.lmer <- lmer(testScore ~ bodyLength2 + (1|mountainRange) + (1|sample), 
				  data = dragons, REML = FALSE)

reduced.lmer <- lmer(testScore ~ 1 + (1|mountainRange) + (1|sample), 
					data = dragons, REML = FALSE)

# annova between the 2 models
anova(reduced.lmer, full.lmer)
```
