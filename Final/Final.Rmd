---
title: "Final"
author: "Sean Fahey"
date: "2023-04-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Hmisc)
library(vegan)
```

# About the Dataset


### Reference

__[Soil Dataset](https://www.kaggle.com/datasets/ramakrishnanthiyagu/soil-compositions)__

Originally distributed by LSU School of Plant, Environmental, and Soil 
Sciences (Dr. Moser Research Laboratory). 

<hr>

### Description

__Summary:__

Soil samples in "commerce silt loam" cotton fields in Louisiana collected 
between 1987 and 1990.

9 response variables were measured at 4 different depths (0-10 cm, 10-30 cm, 
30-60 cm, and 60-90 cm), and 3 different contours (Top, Slope, and Depression).

__Response Variables:__

- pH
- N (total Nitrogen %)
- Dens (soil density in gm/cm^3)
- P (total Phosphorous in ppm)
- Ca (total Calcium in meq/100g)
- Mg (total Magnesium in meq/100g)
- K (total Potassium in meq/100g)
- Na (total Sodium in meq/100g)
- Conduc (conductivity)


```{r import and clean up data}

# Import data csv file
soil = read.csv("Soils.csv")
head(soil)

# Correct the string entries for Depth
soil$Depth[soil$Depth == "0-10"] = "Shallow"
soil$Depth[soil$Depth == "Oct-30"] = "Medium"
soil$Depth[soil$Depth == "30-60"] = "Deep"
soil$Depth[soil$Depth == "60-90"] = "Very Deep"

# convert depth to an ordered factor
soil$Depth = factor(
    soil$Depth,
    ordered = TRUE, 
    levels = c("Shallow", "Medium", "Deep", "Very Deep")
  )

# convert Contour to a factor
soil$Contour = as.factor(soil$Contour)

# Add a group column to the front by combining Depth and Contour columns
group <- paste(soil$Depth, soil$Contour, sep="_")
soil = data.frame(Group = as.factor(group), soil)

# Drop unused columns
soil = subset(soil, select = -c(Group.1, Gp, Block))
```


```{r Visualize, transform, visualize 1}
hist.data.frame(soil[4:12], nclass=10, na.big=TRUE)
dev.print(pdf, 'histograms.pdf')

```

It looks like Nitrogen, Density, and Phosphorous are skewed. It's worth trying 
a log transformation for these 3 and seeing if they substantially improve.

```{r Visualize, transform, visualize 2}

soil$N.sqrt = sqrt(soil$N)
hist.data.frame(soil[c('N', 'N.sqrt')], nclass=10)
dev.print(pdf, 'N-transformation.pdf')


soil$Dens.log = log(soil$Dens)
hist.data.frame(soil[c('Dens', 'Dens.log')], nclass=10)
dev.print(pdf, 'Dens-transformation.pdf')


soil$P.sqrt = sqrt(soil$P)
hist.data.frame(soil[c('P', 'P.sqrt')], nclass=10)
dev.print(pdf, 'P-transformation.pdf')
```

Only Nitrogen seemed to get significantly more normal with a log transformation. 
So I'm dropping the non-transformed Nitrogen column, and the other 2 log 
transformed columns.

```{r drop unnecessary columns}

soil = subset(soil, select = -c(N, Dens.log, P.sqrt))
```

NMDS run for all values of K 1 through 10. This is done to check what number 
of dimensions is best to use for analysis. The number of dimensions is decided
by stress level, with a stress of <0.05 considered to be very good.

```{r figure out how many dimensions are needed}
n = 10
stress <- vector(length = n)
for (i in 1:n) { # loop through values of i 1 through 10
    stress[i] <- metaMDS(
  comm = subset(soil, select = -c(Group, Contour, Depth)), 
  distance = "bray", 
  k = i, # set k to the looped value
  trace = 0)$stress
}

# assign names to the stress vector (values 1 through 10)
names(stress) <- paste0(1:n)

# bar plot for stress vector
bp = barplot(
  stress, 
  ylab = "Stress", 
  xlab = "# of Dimensions", 
  main='Stress by Number of Dimensions in metaMDS', # title
  las = 0,
  
  # y axis scale. Default was causing the highest bar to clip into the title.
  ylim = c(0, 0.085), 
  col = colorRampPalette( # color range for the bars
    colors = c(
      "violet",
      "darkviolet", 
      "darkblue"
      ))(10),
  )

# add text labels to each bar
text(
  bp, 
  stress, # stress vector is used to mark points where text will appear
  round(stress, 4), # text to display
  pos=1, # pos=1 means just below the point
  cex = 0.7, # scale to 70%
  col="white"
  )

dev.print(pdf, 'stress-per-dim.pdf')
```

A 2-dimension NMDS seems to be the best way to go. 1 dimension is already
decent (with a stress level of 0.0757), but 2 dimensions improves the stress
level to 0.0482. Additional dimensions past this point appear to have 
diminishing returns, and are not worth the added difficulty in visualizing the
data. 

```{r metaNMDS with bray-curtis distances}
soil.nmds = metaMDS(
  comm = subset(soil, select = -c(Group, Contour, Depth)),
  distance = "bray", # using bray curtis dissimilarity
  k = 2, 
  trace = 0
  )

```


```{r check stress to verify}
soil.nmds
```
Stress of 0.0482 is considered very good. 


```{r ordination plot with contour labels}
soil.ord = ordiplot(
  soil.nmds, 
  type = 'none', 
  main = paste0( # plot title
    'Contour\nStress = ', 
    round(soil.nmds$stress,dig=4), # add stress label to title
    '\n Shown with 95% confidence intervals around each group'
    ),
  xaxt = 'none', # remove tick marks from NMDS plots 
  yaxt = 'none'
  #cex.main=2,
  #cex.lab=1.3
  ) 

?ordiplot

points(
  soil.ord, 
  what = 'sites', 
  col = as.numeric(soil$Contour), # color by habitat
  pch = as.numeric(soil$Contour), # shape by habitat
  )

legend( # add legend at bottom left
  'topleft', 
  legend = levels(soil$Contour),
  col = 1:4, # make the colors match the points
  pch = 1:4, # make the shapes match
  cex = .7,
  title = "Contour"
  )

ordiellipse(
  soil.nmds, 
  kind = 'sd',
  draw = "polygon", 
  col = 1:4,
  alpha = 0.2,
  groups = soil$Contour, 
  label = TRUE, 
  border = NULL, 
  conf = 0.95,
  lwd = 2
  )

dev.print(pdf, 'ordination-contour.pdf')
```

Contour groups show no discernible differentiation between the 95% confidence 
ellipses.

```{r ordination plot with depth labels}
soil.ord = ordiplot(
  soil.nmds, 
  type = 'none', 
  main = paste0( # plot title
    'Depth\nStress = ', 
    round(soil.nmds$stress,dig=4), # add stress label to title
    '\n Shown with 95% confidence intervals around each group'
    ),
  xaxt = 'none', # remove tick marks from NMDS plots 
  yaxt = 'none'
  ) 

points(
  soil.ord, 
  what = 'sites', 
  col = as.numeric(soil$Depth), # color by habitat
  pch = as.numeric(soil$Depth), # shape by habitat
  )

legend( # add legend at bottom left
  'topright', 
  legend = levels(soil$Depth),
  col = 1:4, # make the colors match the points
  pch = 1:4, # make the shapes match
  cex = .7,
  title = "Depth"
  )

ordiellipse(
  soil.nmds, 
  kind = 'sd', # how to include points, this means all (?)
  draw = "polygon", 
  col = 1:4,
  alpha = 0.2,
  groups = soil$Depth, 
  label = TRUE, 
  border = NULL, 
  conf = 0.95,
  lwd = 2
  )

dev.print(pdf, 'ordination-depth.pdf')
```

Sample depth level shows clear differentiation between 95% confidence ellipses 
for soil depths that are not adjacent in order. However adjacent depth levels 
cannot be differentiated with 95% confidence.

