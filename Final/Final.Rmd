---
title: "Final"
author: "Sean Fahey"
date: "2023-04-23"
output: html_document
---



# To Do:

1. Visualize distribution
    a. Transform which?
    b. Keep transformations?

2. Do PCA

3. Bi-plot

4. Contribution plot
    a.Subset to important data

5. Re-run PCA

6. Bi-plot colored by group, or contour, or depth?

7. RDA

8. anova of RDA

9. triplot with categorical predictors labeled or colored

<hr>


# Questions:

1. Should I do PCA? Or is NMDS always required when units differ?

2. Can I do an RDA? - because I have 2 predictor variables (contour and depth)
RDA is usually tying to compare something measured (species abundance per site)
to something else measured (environmental conditions). Here I only have env. 
conditions and a categorical site. Just an RDA with 2 categorical predictors?
Also, one of the predictors is sort of ordered, but the other isn't. Does this
change anything?

3. The data set says block is random. They added block for some kaggle project.
Can I just drop this column?

4. I made depth ordinal just as a sort of hacky way to get the colors to sort 
right in the PCA plot, but it throws a warning. Is this warning real? Or just
telling me that order is being discarded when drawing shapes?

5. 

5. Can we attend this Wednesday if not presenting?




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Hmisc)
library(ggfortify)
library(factoextra)
```

# About the Dataset


### Reference

__[Soil Dataset](https://www.kaggle.com/datasets/ramakrishnanthiyagu/soil-compositions)__

Originally distributed by LSU School of Plant, Environmental, and Soil 
Sciences (Dr. Moser Research Laboratory). 

<hr>

### Description

__Summary:__

Soil samples in "commerce silt loam" cotton fields in Louisiana collected 
between 1987 and 1990.

9 response variables were measured at 4 different depths (0-10 cm, 10-30 cm, 
30-60 cm, and 60-90 cm), and 3 different contours (Top, Slope, and Depression).

__Response Variables:__

- pH
- N (total Nitrogen %)
- Dens (soil density in gm/cm^3)
- P (total Phosphorous in ppm)
- Ca (total Calcium in meq/100g)
- Mg (total Magnesium in meq/100g)
- K (total Phosphorous in meq/100g)
- Na (total Sodium in meq/100g)
- Conduc (conductivity)


```{r import and clean up data}
# Import data csv file
soil = read.csv("Soils.csv")
head(soil)

# Correct the string entries for Depth
soil$Depth[soil$Depth == "0-10"] = "Shallow"
soil$Depth[soil$Depth == "Oct-30"] = "Medium"
soil$Depth[soil$Depth == "30-60"] = "Deep"
soil$Depth[soil$Depth == "60-90"] = "Very Deep"

soil$Depth = factor(
    soil$Depth, 
    ordered = TRUE, 
    levels = c("Shallow", "Medium", "Deep", "Very Deep")
  )

# Add a group column to the front by combining Depth and Contour columns
group <- paste(soil$Depth, soil$Contour, sep="_")
soil = data.frame(Group = as.factor(group), soil)

# Drop unused columns
soil = subset(soil, select = -c(Group.1, Gp, Block))

head(soil)
```



```{r Visualize, transform, visualize}
hist.data.frame(soil[4:12], nclass=10)

# It looks like Nitrogen, Density, and Phosphorous are skewed. It's worth
# trying a log transformation for these 3 and seeing if they substantially
# improve.

soil$N.log = log(soil$N)
hist.data.frame(soil[c('N', 'N.log')], nclass=10)

soil$Dens.log = log(soil$Dens)
hist.data.frame(soil[c('Dens', 'Dens.log')], nclass=10)

soil$P.log = log(soil$P)
hist.data.frame(soil[c('P', 'P.log')], nclass=10)
```


```{r drop unnecessary columns}
# Only Nitrogen seemed to get significantly more normal with a log 
# transformation. So I'm dropping the non-transformed Nitrogen column, and the
# other 2 log transformed columns.

soil = subset(soil, select = -c(N, Dens.log, P.log))
```


```{r PCA 1}
soil.pca1 = prcomp(subset(soil, select = -c(Group, Contour, Depth)), scale=TRUE)
autoplot(soil.pca1)
```

```{r checking contribution of each principal component}
summary(soil.pca1)

# ~81.5% of variance can be explained by the first 2 component, with 73.2% of
# the variance being explained by just the first principal component alone.
```

```{r contribution plot}
fviz_contrib(soil.pca1, choice="var", axes = 1)

# Component 1 is primarily driven by Conductivity, log(Nitrogen), Sodium, 
# Calcium, and Density.

fviz_contrib(soil.pca1, choice="var", axes = 2)

# Component 2 is driven almost entirely by just Magnesium
```


```{r biplot 1}
fviz_pca_biplot(
  soil.pca1, 
  axes = c(1, 2), 
  geom = c("point"),
  geom.var = c("arrow", "text"), # suppressed arrows
  col.ind = soil$Depth,
  addEllipses = TRUE, 
  ellipse.type = 'convex'
  )

```




```{r PCA 2 dropping less important variables}
soil.less = subset(soil, select = -c(P, pH, K))

```




```{r PCA 2}
soil.pca2 = prcomp(subset(soil.less, select = -c(Group, Contour, Depth)), scale=TRUE)
autoplot(soil.pca2)

```




```{r summary 2}
summary(soil.pca2)

# Now a full 89% of the variance is explained by the first 2 principal 
# components
```

```{r biplot 2}
fviz_pca_biplot(
  soil.pca2, 
  axes = c(1, 2), 
  geom = c("point"),
  geom.var = c("arrow", "text"), # suppressed arrows
  col.ind = soil$Group,
  addEllipses = TRUE, 
  ellipse.type = 'convex'
  )
```
















