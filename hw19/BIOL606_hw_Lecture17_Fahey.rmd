---
title: "Lecture 17"
author: "Sean Fahey"
date: "2023-04-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(vegan)

```


# In Class Work

### Redundancy Analysis (RDA)
- One common use: exploring relationships between species abundance and 
environment variables.
- Species is typically the response
- Measure abundance of n species in each plot
- Sites/plots are typically the replicates
- Also measure some env. characteristics of each site/plot.


---

- RDA uses euclidean distances
- Finds linear relationship between predictors and response distances.
- Assumes casual relationship between predictors and response variables
- Response variables can be different types, but must be standardized
- Predictors can be standardized, but don't have to be

```{r import data}
veg = read.csv("bryceveg.txt", header=TRUE, sep=' ', row.names=1)
sites = read.csv("brycesite.txt", header=TRUE, sep=' ', row.names=1)
```



```{r center and scale}
veg.center = scale(veg, center = TRUE, scale = TRUE)

env = with(
  sites, 
  cbind(elev, av, slope)
  )
env.scale = as.data.frame(scale(env, center = TRUE, scale = TRUE))
```



```{r vegitation RDA}
veg.rda = rda(
  veg.center ~ elev + av + slope, 
  data=env.scale
  )

veg.rda
```


```{r veg rda triplot}
plot(
  veg.rda, 
  scaling = 2, 
  main = 'Scaling = 2, correlation plot', # title
  display = c('sites', 'species', 'bp')
  )

```
- scaling = 2: emphasize correlation between vectors and distances between 
sites
- similar angles: high correlation
- 90 degrees off: no correlation
- sites falling further out along predictor are more strongly associated with 
that predictor


```{r anova of the RDA analysis}
anova(veg.rda)

```
F value of 2.8, p value of < 0.001.

This means that our predictors combined seem to have a significant relationship
with the ordination space from the RDA of our species counts


```{r adding a categorical predictor}
sites$pos = as.factor(sites$pos)
env.scale$pos = sites$pos

veg.rda2 = rda(
  veg.center ~ elev + av + slope + pos, 
  data=env.scale
  )

anova(veg.rda2)
```



```{r anova by term}
anova(veg.rda2, by='term')

```
Looks like position and elevation are the important terms.


```{r anova by axis}
anova(veg.rda2, by='axis')

```



```{r}
plot(
  veg.rda2, 
  scaling = 2, 
  main = 'Scaling = 2, correlation plot', # title
  display = c('sites', 'species', 'bp')
  )
```



```{r import snail data}
snails = read.table('SmallSnailData.txt', header=TRUE, sep=' ')
head(snails)
```
field sites (col 5-8) can be predictors

```{r scale snail}
shelldata = snails[,2:4]
sitedata = snails[,5:8]

rownames(shelldata) = as.character(snails$Site)
rownames(sitedata) = as.character(snails$Site)

shell.center = as.data.frame(scale(shelldata))
site.center = as.data.frame(scale(sitedata))
```



```{r snail rda}
snail.rda = rda(
  shell.center~Rainfall.mm. + DryMonths + MeanTempC, 
  data=site.center, 
  scale=FALSE # already scaled, don't do it again.
  )

anova(snail.rda, by = 'term')
```


Doing scaling=2 so euclidean distances are best represented between species
(blue arrows)

```{r plot snail rda}
plot(
  snail.rda, 
  scaling = 1, 
  main = 'Scaling = 1, correlation plot', # title
  display = c('sites', 'species', 'bp')
  )
```



```{r again with scaling 2}
plot(
  snail.rda, 
  scaling = 2, 
  main = 'Scaling = 2, correlation plot', # title
  display = c('sites', 'species', 'bp')
  )
```

### What if Eudledian distances aren't ideal?
- CCA: Canonical Correspondence Analysis from vegan
  - Uses chi squared
- Others like Bray-Curtis can also be used.

```{r decostand chi sq}
veg.chi = decostand(veg, method='chi.square')
veg.rda.chi = rda(
  veg.chi ~ elev + av + slope, 
  data=env.scale
  )

anova(veg.rda.chi, by='terms')
```
Using chi squared means rare species will be more emphasized at the expense
of common species.


```{r}

```

----


# Notes for FINAL

1. Analyze multivariate data set
  a. Do an ordination, and optionally other analyses (like permanova)
2. Components:
  a. 10 minute conference style presentation (50 pts)
  b. .Rmd file and data file submission (10 pts)
  c. 

in presentation: reference specific packages, but don't show slides full of 
code (but not ggplot, ggfortify, other super basics that don't manipulate the 
data). We care more about specifically which rda function from which package 
we used
in write-up: cite packages
if you borrow images, credit the author

comment Rmd file HEAVILY. A person should be able to return to this document 
in a year and understand what the flow was and what each cell is doing without 
running it.

No extra points for doing NMDS vs. PCA vs. others. But must use the RIGHT 
ONE. And interpret it correctly. And comment on it approprately.


Methods and results:
Breif, but descriptive. Scientific language.











